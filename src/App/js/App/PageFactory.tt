<#@ template language="C#" hostspecific="true" #>
<#@ output extension=".ts" #>
<#@ assembly name="System.Core" #>  
<#@ import namespace="System.IO" #>
<#@ import namespace="System.Linq" #>
import {IPageRepository} from 'AppFramework/AppFactory';
<#

	var templateFile = Host.TemplateFile;
	var currentDirectory = Path.GetDirectoryName(templateFile);
	var pagesDirectoryPath = Path.Combine(currentDirectory, "Pages");
	var pageFiles = Directory.GetFiles(pagesDirectoryPath, "*.ts", SearchOption.AllDirectories)
							 .OrderBy(x => Path.GetDirectoryName(x))
							 .ThenBy(x => !IsDefaultPage(x))
							 .ToArray();

	foreach (var pageFile in pageFiles) {#>
import <#=GetAliasName(pageFile, currentDirectory)#> from '<#=GetModuleName(pageFile, currentDirectory)#>';
<#}#>

const pageFactory = {
	replacePages(repository : IPageRepository) : void {
<# foreach (var pageFile in pageFiles) {#>
		repository.replacePage(require('<#=GetModuleName(pageFile, currentDirectory)#>').default);
<#}#>
},

	installPages(repository : IPageRepository) : void {
		const pages = [
<# foreach (var pageFile in pageFiles) {#>
			<#=GetAliasName(pageFile, currentDirectory)#><#=EmitComma(pageFile, pageFiles)#>
<#}#>
		];

		repository.addPages(pages);
	}
}

export default pageFactory;

<#+
	static string GetAliasName(string pageFile, string currentDirectory) {
		string moduleName = GetModuleName(pageFile, currentDirectory);
		string alias = moduleName.Replace("Pages/", "").Replace("./", "").Replace("/", "_");
		return alias + "Registration";
	}

	static string GetModuleName(string pageFile, string currentDirectory) {
		string relativePath = pageFile.Substring(currentDirectory.Length + 1);
		string withoutExtension = relativePath.Replace(".ts", "");
		string forwardSlash = withoutExtension.Replace("\\", "/");
		return "./" + forwardSlash;
	}

	static string EmitComma(string item, string[] array) {
		int itemIndex = Array.IndexOf(array, item);
		return itemIndex == array.Length - 1 ? "" : ",";
	}

	static bool IsDefaultPage(string item) {
		return item.Contains("DefaultPage");
	}
#>